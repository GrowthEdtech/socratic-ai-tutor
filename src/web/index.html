<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Socratic AI Pro | Upgrade Your Learning</title>
    <link rel="stylesheet" href="upgrade.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- PayPal SDK -->
    <script
        src="https://www.paypal.com/sdk/js?client-id=AYMGr_yLQJC1E9jG5XX8pR0X4GEDDsp7PfEFR6J4ZlJ1GFIRK4blB4RsRIgNg9NIb2eyYI1i1AtqEeP8&currency=USD"></script>
</head>

<body>
    <div class="glow-container">
        <div class="glow glow-1"></div>
        <div class="glow glow-2"></div>
    </div>

    <nav>
        <div class="nav-content">
            <div class="logo">
                <div class="logo-circle">
                    <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                        <circle cx="12" cy="12" r="10" />
                        <circle cx="9" cy="10" r="1.5" />
                        <circle cx="15" cy="10" r="1.5" />
                        <path d="M12 13l-1 1 1 1" />
                    </svg>
                </div>
                <span>SOCRATIC AI</span>
            </div>
            <div class="nav-right" id="nav-user-controls">
                <div class="energy-badge state-user-only">
                    <span class="zap">‚ö°</span> <span id="energy-count">--</span>
                </div>
                <div class="user-profile state-user-only" id="user-profile">
                    <div class="avatar-placeholder"></div>
                </div>
                <!-- Login Button (Guest Only) - Official Google Brand -->
                <button id="web-login-btn" class="google-btn state-guest-only" type="button">
                    <div class="google-btn-icon-wrapper">
                        <svg class="google-btn-icon" viewBox="0 0 48 48">
                            <path fill="#EA4335"
                                d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z">
                            </path>
                            <path fill="#4285F4"
                                d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z">
                            </path>
                            <path fill="#FBBC05"
                                d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24s.92 7.54 2.56 10.78l7.97-6.19z">
                            </path>
                            <path fill="#34A853"
                                d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z">
                            </path>
                            <path fill="none" d="M0 0h48v48H0z"></path>
                        </svg>
                    </div>
                    <span class="google-btn-text">Sign in with Google</span>
                </button>
                <!-- Logout Button (User Only) -->
                <button id="web-logout-btn" class="btn secondary state-user-only"
                    style="padding: 6px 12px; font-size: 0.8rem; border-color: rgba(255,255,255,0.2);">Sign
                    Out</button>
            </div>
        </div>
    </nav>

    <main>
        <!-- ... existing content ... -->
        <section class="hero">
            <h1>Elevate Your Intelligence</h1>
            <p class="subtitle">Join thousands of students mastering complex concepts with Socratic Pro.</p>
        </section>

        <section class="pricing" id="pricing">
            <div class="card">
                <div class="card-header">
                    <h3>ENERGY STARTER</h3>
                    <div class="price">$19.90</div>
                </div>
                <ul class="features">
                    <li><span class="icon">‚ö°</span> 400 Zap Credits</li>
                    <li><span class="icon">‚úì</span> AI Socratic Tutoring</li>
                    <li><span class="icon">‚úì</span> 1M Context Window</li>
                    <li><span class="icon">‚úì</span> 7-Day History Access</li>
                </ul>
                <button class="btn secondary state-guest-only auth-trigger">Sign in to
                    Buy</button>
                <div id="paypal-button-container-starter" class="paypal-container state-user-only"></div>
            </div>

            <div class="card pro">
                <div class="popular-badge">BEST VALUE</div>
                <div class="card-header">
                    <h3>ENERGY ADVANCE</h3>
                    <div class="price">$49</div>
                </div>
                <ul class="features">
                    <li><span class="icon">‚ö°</span> 1,200 Zap Credits</li>
                    <li><span class="icon">‚òÖ</span> AI Visual Reasoning</li>
                    <li><span class="icon">‚òÖ</span> Priority Gemini API</li>
                    <li><span class="icon">‚òÖ</span> 30-Day History</li>
                </ul>
                <button class="btn primary state-guest-only auth-trigger">Sign in to
                    Buy</button>
                <div id="paypal-button-container-advance" class="paypal-container state-user-only"></div>
            </div>

            <div class="card premium">
                <div class="card-header">
                    <h3>ENERGY SCHOLAR</h3>
                    <div class="price">$69</div>
                </div>
                <ul class="features">
                    <li><span class="icon">‚ö°</span> 1,800 Zap Credits</li>
                    <li><span class="icon">‚òÖ</span> Advanced Reasoning Models</li>
                    <li><span class="icon">‚òÖ</span> Unlimited Scan History</li>
                    <li><span class="icon">‚òÖ</span> 24/7 Priority Support</li>
                </ul>
                <button class="btn primary state-guest-only auth-trigger">Sign in to
                    Buy</button>
                <div id="paypal-button-container-scholar" class="paypal-container state-user-only"></div>
            </div>

            <div class="card ultimate">
                <div class="card-header">
                    <h3>MEGA BUNDLE</h3>
                    <div class="price">$99</div>
                </div>
                <ul class="features">
                    <li><span class="icon">‚ö°</span> 3,000 Zap Credits</li>
                    <li><span class="icon">‚òÖ</span> Personal AI Mentor</li>
                    <li><span class="icon">‚òÖ</span> Everything in Scholar +</li>
                    <li><span class="icon">‚òÖ</span> Beta Feature Access</li>
                </ul>
                <button class="btn primary state-guest-only auth-trigger">Sign in to
                    Buy</button>
                <div id="paypal-button-container-mega" class="paypal-container state-user-only"></div>
            </div>
        </section>

        <!-- Energy Consumption Guide -->
        <section class="energy-rules">
            <div class="rules-container">
                <div class="rules-header">
                    <h2>‚ö° Energy Consumption Guide</h2>
                    <p>Transparent pricing for intelligent reasoning</p>
                </div>
                <div class="rules-grid">
                    <div class="rule-card">
                        <div class="rule-icon">üí¨</div>
                        <h4>L1: Discovery Tutor</h4>
                        <p>Standard text-based guided questioning.</p>
                        <div class="rule-cost">3 Zaps / Query</div>
                    </div>
                    <div class="rule-card">
                        <div class="rule-icon">üëÅÔ∏è</div>
                        <h4>L2: Visual Tutor</h4>
                        <p>AI analysis of screenshots and diagrams.</p>
                        <div class="rule-cost">8 Zaps / Query</div>
                    </div>
                    <div class="rule-card">
                        <div class="rule-icon">üß†</div>
                        <h4>L3: Thinking Mode</h4>
                        <p>Advanced chain-of-thought reasoning.</p>
                        <div class="rule-cost">Coming Soon</div>
                    </div>
                </div>
                <p class="rules-note">* Costs are calculated based on AI inference complexity to ensure the highest
                    quality tutoring.</p>
            </div>
        </section>

        <section class="billing-history state-user-only" id="billing-history">
            <div class="section-header">
                <h2>Transaction History</h2>
                <div class="history-tabs">
                    <button class="tab-btn active" data-tab="transactions">Transactions</button>
                    <button class="tab-btn" data-tab="usage">Energy Usage</button>
                </div>
            </div>

            <div class="history-container">
                <!-- Transactions Tab -->
                <div id="transactions" class="tab-content active">
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Plan</th>
                                <th>Amount</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="history-body">
                            <tr class="empty-state">
                                <td colspan="4">No transaction history found.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Energy Usage Tab -->
                <div id="usage" class="tab-content">
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Activity</th>
                                <th>Change</th>
                                <th>Balance</th>
                            </tr>
                        </thead>
                        <tbody id="usage-body">
                            <tr class="empty-state">
                                <td colspan="4">No energy usage recorded.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Legitimate Footer with Trust Markers -->
        <section class="trust-footer">
            <div class="trust-content">
                <div class="links">
                    <a href="legal.html?page=privacy">Privacy Policy</a>
                    <a href="legal.html?page=terms">Terms of Service</a>
                    <a href="legal.html?page=refund">Refund Policy</a>
                    <a href="legal.html?page=compliance">Compliance</a>
                    <a href="legal.html?page=contact">Contact Support</a>
                </div>
                <p class="copyright">&copy; 2026 Socratic AI. All rights reserved.</p>
                <p class="disclaimer">Socratic AI is a research preview tool. Energy points have no monetary value.</p>
            </div>
        </section>
    </main>

    <!-- Firebase SDK Integration -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithRedirect, getRedirectResult, GoogleAuthProvider, signOut, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, updateDoc, arrayUnion, increment, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // Firebase Configuration (Matching Extension)
        const firebaseConfig = {
            apiKey: "AIzaSyDTn4TXLQCQHvtU_fwk-8lZd-6Nx5Udj7M",
            authDomain: "socratic-ai-82849.firebaseapp.com",
            projectId: "socratic-ai-82849",
            storageBucket: "socratic-ai-82849.firebasestorage.app",
            messagingSenderId: "528705306538",
            appId: "1:528705306538:web:2982f568ec05ee08a575d3"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        const energyCountLabel = document.getElementById('energy-count');
        const profileContainer = document.getElementById('user-profile');
        const loginBtn = document.getElementById('web-login-btn');
        const logoutBtn = document.getElementById('web-logout-btn');

        // Global Error Capture
        window.onerror = function (msg, url, line) {
            alert("System Error: " + msg + "\nAt: " + line);
            return false;
        };

        // 0. Unified Auth Logic
        async function runGoogleAuthFlow() {
            console.log("Auth Sequence: Iniciating Google Sign-In...");

            // Visual feedback
            const allAuthButtons = document.querySelectorAll('#web-login-btn, .auth-trigger');
            allAuthButtons.forEach(b => {
                b.style.opacity = '0.7';
                b.style.pointerEvents = 'none';
            });

            try {
                // We prefer popup for desktop as it's more intuitive
                console.log("Auth Sequence: Attempting signInWithPopup");
                const result = await signInWithPopup(auth, provider);
                console.log("Auth Sequence: Popup Success", result.user.email);
            } catch (error) {
                console.warn("Auth Sequence: Popup blocked or failed", error.code);

                // Nuclear fallback to Redirect for mobile/restricted environments
                if (error.code === 'auth/popup-blocked' || error.code === 'auth/cancelled-popup-request' || error.code === 'auth/popup-closed-by-user') {
                    console.log("Auth Sequence: Pivoting to signInWithRedirect");
                    await signInWithRedirect(auth, provider);
                } else if (error.code === 'auth/unauthorized-domain') {
                    alert("Critical: This domain is not authorized in Firebase Console. Please add your current domain to the authorized list.");
                } else {
                    console.error("Auth Sequence: Final Error", error);
                    alert("Authentication Error: " + error.message);
                }
            } finally {
                allAuthButtons.forEach(b => {
                    b.style.opacity = '1';
                    b.style.pointerEvents = 'auto';
                });
            }
        }

        // 1. Initial Sync from URL Params (Fast display)
        const urlParams = new URLSearchParams(window.location.search);
        const pictureUrl = urlParams.get('picture');
        const initial = urlParams.get('initial');
        const energyValue = urlParams.get('energy');

        if (energyValue) energyCountLabel.innerText = energyValue;
        if (pictureUrl) {
            profileContainer.innerHTML = `<img src="${pictureUrl}" alt="Avatar" style="width:100%;height:100%;object-fit:cover;display:block;border-radius:50%;">`;
        } else if (initial) {
            profileContainer.innerHTML = `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:var(--accent-primary);color:white;font-weight:700;border-radius:50%;">${initial}</div>`;
        }

        // 2. Real-time Firebase Sync (Consolidated)
        onAuthStateChanged(auth, (user) => {
            const body = document.body;
            const heroTitle = document.querySelector('.hero h1');
            const heroSubtitle = document.querySelector('.hero p');

            if (user) {
                console.log("Web Auth: Active User Session Detected", user.uid);
                body.classList.add('is-authenticated');

                // Update Hero for Personal Dashboard Mode
                heroTitle.innerText = `Welcome Back, ${user.displayName || 'Scholar'}`;
                heroSubtitle.innerText = "Manage your zap credits and view your intelligence growth.";

                // Update Avatar
                if (user.photoURL) {
                    profileContainer.innerHTML = `<img src="${user.photoURL}" alt="Avatar" style="width:100%;height:100%;object-fit:cover;display:block;border-radius:50%;">`;
                }

                // Listen for Energy Changes
                const userDocRef = doc(db, 'users', user.uid);
                onSnapshot(userDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        energyCountLabel.innerText = data.energyBalance || 0;
                        renderHistory(data.transactions || []);
                    }
                });

                // Initialize PayPal Buttons (Only if authenticated)
                const containers = document.querySelectorAll('.paypal-container');
                if (containers.length > 0) {
                    containers.forEach(c => c.innerHTML = '');
                    initPayPalButton('#paypal-button-container-starter', "19.90", 400, "Energy Starter");
                    initPayPalButton('#paypal-button-container-advance', "49.00", 1200, "Energy Advance");
                    initPayPalButton('#paypal-button-container-scholar', "69.00", 1800, "Energy Scholar");
                    initPayPalButton('#paypal-button-container-mega', "99.00", 3000, "Mega Bundle");
                }

            } else {
                console.log("Web Auth: Guest Mode - Ready for Sign-In");
                body.classList.remove('is-authenticated');

                // Reset Hero for Promotional Mode
                heroTitle.innerText = "Elevate Your Intelligence";
                heroSubtitle.innerText = "Join thousands of students mastering complex concepts with Socratic Pro.";

                energyCountLabel.innerText = 'Login';

                // Clear stateful content
                document.querySelectorAll('.paypal-container').forEach(c => c.innerHTML = '');
            }
        });

        // 3. Render Transaction History
        function renderHistory(transactions) {
            const historyBody = document.getElementById('history-body');
            const usageBody = document.getElementById('usage-body');

            if (transactions.length === 0) return;

            // Sort by date descending
            const sorted = [...transactions].sort((a, b) => (b.date?.seconds || 0) - (a.date?.seconds || 0));

            historyBody.innerHTML = sorted.map(t => `
                <tr>
                    <td>${t.date ? new Date(t.date.seconds * 1000).toLocaleDateString() : 'Pending'}</td>
                    <td>${t.packageName}</td>
                    <td>${t.amount}</td>
                    <td><span class="status-pill completed">COMPLETED</span></td>
                </tr>
            `).join('');

            usageBody.innerHTML = sorted.map(t => `
                <tr>
                    <td>${t.date ? new Date(t.date.seconds * 1000).toLocaleDateString() : 'Pending'}</td>
                    <td>Purchase: ${t.packageName}</td>
                    <td>+${t.zaps}‚ö°</td>
                    <td>--</td>
                </tr>
            `).join('');
        }

        // 4. Delegated Event Listeners (Bulletproof Pattern)
        document.addEventListener('click', (e) => {
            // Check if clicked element is an auth trigger or child of one
            const target = e.target.closest('#web-login-btn') || e.target.closest('.auth-trigger');
            if (target) {
                e.preventDefault();
                runGoogleAuthFlow();
            }
        });

        console.log("System Status: Auth Module Fully Initialized & Delegated");

        // 5. Logout Action
        logoutBtn.addEventListener('click', () => {
            signOut(auth).then(() => {
                window.location.reload(); // Refresh to ensure clean state
            }).catch((error) => {
                console.error("Logout Error:", error);
            });
        });

        // 4. Handle Redirect Result (Catch errors on return)
        getRedirectResult(auth).catch((error) => {
            console.error("Login Result Error:", error);
            if (error.code === 'auth/unauthorized-domain') {
                alert("Domain not authorized in Firebase Console.");
            }
        });

        // 4. Tab Switching Logic
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');

        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const tabId = btn.getAttribute('data-tab');
                tabBtns.forEach(b => b.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(tabId).classList.add('active');
            });
        });

        // Handle Anchor Link
        if (window.location.hash === '#usage') {
            const usageBtn = document.querySelector('[data-tab="usage"]');
            if (usageBtn) usageBtn.click();
        }

        // --- PayPal Purchase Logic ---
        function initPayPalButton(containerId, amount, zaps, packageName) {
            paypal.Buttons({
                style: {
                    layout: 'vertical',
                    color: 'blue',
                    shape: 'rect',
                    label: 'paypal'
                },
                createOrder: function (data, actions) {
                    return actions.order.create({
                        purchase_units: [{
                            description: packageName,
                            amount: {
                                currency_code: "USD",
                                value: amount
                            }
                        }]
                    });
                },
                onApprove: function (data, actions) {
                    return actions.order.capture().then(async function (orderData) {
                        console.log('Capture result', orderData, JSON.stringify(orderData, null, 2));
                        const user = auth.currentUser;
                        if (user) {
                            const userDocRef = doc(db, 'users', user.uid);
                            // Update Energy Balance & Log Transaction
                            await updateDoc(userDocRef, {
                                energyBalance: increment(zaps),
                                transactions: arrayUnion({
                                    id: orderData.id,
                                    date: serverTimestamp(),
                                    amount: `$${amount}`,
                                    packageName: packageName,
                                    zaps: zaps,
                                    status: 'COMPLETED'
                                })
                            });
                            alert(`Purchase Successful! Added ${zaps} Zaps.`);
                        }
                    });
                },
                onError: function (err) {
                    console.error('PayPal Error:', err);
                    alert("Payment failed. Please try again.");
                }
            }).render(containerId);
        }

        // Remove redundant redundant auth listener to prevent state racing
    </script>
</body>

</html>