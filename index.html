<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Socratic AI Pro | Upgrade Your Learning</title>
    <link rel="stylesheet" href="upgrade.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- PayPal SDK -->
    <script
        src="https://www.paypal.com/sdk/js?client-id=AYMGr_yLQJC1E9jG5XX8pR0X4GEDDsp7PfEFR6J4ZlJ1GFIRK4blB4RsRIgNg9NIb2eyYI1i1AtqEeP8&currency=USD"></script>
</head>

<body>
    <div class="glow-container">
        <div class="glow glow-1"></div>
        <div class="glow glow-2"></div>
    </div>

    <nav>
        <div class="nav-content">
            <div class="logo">
                <div class="logo-circle">
                    <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                        <circle cx="12" cy="12" r="10" />
                        <circle cx="9" cy="10" r="1.5" />
                        <circle cx="15" cy="10" r="1.5" />
                        <path d="M12 13l-1 1 1 1" />
                    </svg>
                </div>
                <span>SOCRATIC AI</span>
            </div>
            <div class="nav-right" id="nav-user-controls">
                <div class="energy-badge state-user-only">
                    <span class="zap">‚ö°</span> <span id="energy-count">--</span>
                </div>
                <div class="user-profile state-user-only" id="user-profile">
                    <div class="avatar-placeholder"></div>
                </div>
                <!-- Login Button (Guest Only) - Official Google Brand -->
                <button id="web-login-btn" class="google-btn state-guest-only" type="button">
                    <div class="google-btn-icon-wrapper">
                        <svg class="google-btn-icon" viewBox="0 0 48 48">
                            <path fill="#EA4335"
                                d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z">
                            </path>
                            <path fill="#4285F4"
                                d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z">
                            </path>
                            <path fill="#FBBC05"
                                d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24s.92 7.54 2.56 10.78l7.97-6.19z">
                            </path>
                            <path fill="#34A853"
                                d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z">
                            </path>
                            <path fill="none" d="M0 0h48v48H0z"></path>
                        </svg>
                    </div>
                    <span class="google-btn-text">Sign in with Google</span>
                </button>
                <!-- Logout Button (User Only) -->
                <button id="web-logout-btn" class="btn secondary state-user-only"
                    style="padding: 6px 12px; font-size: 0.8rem; border-color: rgba(255,255,255,0.2);">Sign
                    Out</button>
            </div>
        </div>
    </nav>

    <main>
        <!-- Background Decorative Orbs -->
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <div class="orb orb-3"></div>
        <!-- ... existing content ... -->
        <section class="hero">
            <div class="hero-badge">Next-Gen Socratic Reasoning</div>
            <h1>Solve. Think. Master.</h1>
            <p class="subtitle">Built on the architecture of Gemini & Genie 3, Socratic AI is your personal intellectual
                catalyst. We don't just give you answers; we teach you how to think.</p>
            <div class="hero-actions">
                <a href="#features" class="btn primary">Discover the Logic</a>
                <a href="#pricing" class="btn secondary">View Plans</a>
            </div>
        </section>

        <!-- Product Pillars: The "Why" Section -->
        <section id="features" class="pillars reveal">
            <div class="section-label">THE SOCRATIC EDGE</div>
            <h2 class="section-title">Beyond Artificial Intelligence.<br><span>Intellectual Partnership.</span></h2>

            <div class="pillar-grid">
                <div class="pillar-card glass-flat">
                    <div class="pillar-icon">üß†</div>
                    <h3>Multi-Modal Reasoning</h3>
                    <p>Powered by advanced visual reasoning, Socratic AI "sees" complex diagrams and handwritten notes,
                        decomposing them into logical first principles.</p>
                </div>
                <div class="pillar-card glass-flat">
                    <div class="pillar-icon">üéØ</div>
                    <h3>Precision Correction</h3>
                    <p>Instead of silent errors, our AI identifies the exact "Logic Leak" in your thinking, providing
                        targeted hints to steer you back to the solution.</p>
                </div>
                <div class="pillar-card glass-flat">
                    <div class="pillar-icon">üìö</div>
                    <h3>1M Context Mastery</h3>
                    <p>Your entire curriculum in one prompt. Upload thousands of pages and query your knowledge base
                        with zero-loss retrieval performance.</p>
                </div>
            </div>
        </section>

        <!-- The Learning Flywheel: Scientific Foundation -->
        <section class="flywheel reveal">
            <div class="section-label">THE COGNITIVE ENGINE</div>
            <h2 class="section-title">The Science of <span>Self-Actualization</span></h2>
            <div class="flywheel-grid">
                <div class="flywheel-step">
                    <div class="step-num">01</div>
                    <h4>Diagnostic Priming</h4>
                    <p>Instead of solving, we probe. The AI identifies the boundaries of your current knowledge through
                        targeted inquiry.</p>
                </div>
                <div class="flywheel-step">
                    <div class="step-num">02</div>
                    <h4>Cognitive Scaffolding</h4>
                    <p>We provide the minimum viable hint needed to spark the "Aha!" moment. This strengthens neural
                        pathways related to logic retrieval.</p>
                </div>
                <div class="flywheel-step">
                    <div class="step-num">03</div>
                    <h4>Logical Synthesis</h4>
                    <p>You solve the problem. The AI then asks you to explain the solution back, cementing the logic
                        into your long-term memory.</p>
                </div>
            </div>
        </section>

        <!-- Problem/Solution: The Impact Layer -->
        <section class="impact-viz reveal">
            <div class="impact-content">
                <div class="text-block">
                    <div class="tag">SOLVING THE IMPOSSIBLE</div>
                    <h2>The End of Academic<br>Friction.</h2>
                    <p>Traditional AI is a shortcut. Socratic Pro is the treadmill for your mind. We solve the 3 biggest
                        friction points in modern learning:</p>
                    <ul class="impact-list">
                        <li>
                            <strong>Stuck on Step 1:</strong> Our "Context-Aware Priming" provides the bridge between
                            the question and your existing knowledge.
                        </li>
                        <li>
                            <strong>Hallucinations:</strong> Our "Dual-Verification Engine" cross-references every
                            logical leap with formal reasoning frameworks.
                        </li>
                        <li>
                            <strong>Retention Decay:</strong> Strategic pedagogical spacing ensures that once you solve
                            it, you never forget the underlying logic.
                        </li>
                    </ul>
                </div>
                <div class="viz-block">
                    <img src="socratic_reasoning_flow_viz_1770014536474.png" alt="Logic Flow Visualization"
                        class="floating-viz">
                </div>
            </div>
        </section>

        <!-- Interactive Socratic Demo -->
        <section class="socratic-demo state-guest-only reveal">
            <div class="section-label">THE METHOD IN ACTION</div>
            <h2 class="section-title">See How We Teach,<br><span>Not Just Tell.</span></h2>

            <div class="demo-container glass-flat">
                <div class="demo-chat">
                    <div class="chat-bubble user">
                        "Can you solve this integral for me?"
                    </div>
                    <div class="chat-bubble ai">
                        "I can certainly help you master it! Before we jump to the end, what is the first thing you
                        notice about the relationship between the numerator and the denominator?"
                    </div>
                    <div class="chat-bubble user">
                        "The numerator looks like the derivative of the denominator?"
                    </div>
                    <div class="chat-bubble ai">
                        "Exactly. That insight is the key to the substitution method. If $u = x^2 + 1$, what does $du$
                        become?"
                    </div>
                </div>
                <div class="demo-insight">
                    <h4>The Socratic Advantage</h4>
                    <p>Instead of a static output, our AI maintains a <strong>Pedagogical Loop</strong>. We guide your
                        focus toward the "pivot points" of a problem, ensuring the logic becomes part of your long-term
                        memory.</p>
                    <div class="insight-badge">85% Higher Retention Rate</div>
                </div>
            </div>
        </section>

        <!-- Case Studies / Testimonials -->
        <section class="testimonials reveal">
            <div class="section-label">SCHOLAR VOICES</div>
            <h2 class="section-title">High-Stakes Results</h2>
            <div class="testimonial-grid">
                <div class="testimonial-card glass-flat">
                    <p>"The 1M context window is a game changer for my PhD research. I can cross-reference my entire
                        literature review in seconds."</p>
                    <div class="author">
                        <span class="name">Dr. Aris T.</span>
                        <span class="role">Computational Biology, Oxford</span>
                    </div>
                </div>
                <div class="testimonial-card glass-flat">
                    <p>"Typical AI just gives the answer. Socratic AI forced me to understand the underlying physics. My
                        grades jumped from B to A+."</p>
                    <div class="author">
                        <span class="name">James L.</span>
                        <span class="role">Engineering Student, MIT</span>
                    </div>
                </div>
                <div class="testimonial-card glass-flat">
                    <p>"I use it to scan 500-page legal documents and find logical inconsistencies. It's like having a
                        senior partner sitting next to me."</p>
                    <div class="author">
                        <span class="name">Sarah M.</span>
                        <span class="role">Corporate Law Associate</span>
                    </div>
                </div>
            </div>
        </section>

        <section class="trust-bar state-guest-only reveal">
            <p>Empowering scholars at the world's most innovative institutions</p>
            <div class="logo-cloud">
                <span>OXFORD</span>
                <span>MIT</span>
                <span>STANFORD</span>
                <span>THU</span>
                <span>HKU</span>
            </div>
        </section>

        <section class="pricing" id="pricing">
            <div class="section-label">INVEST IN YOURSELF</div>
            <h2 class="section-title">Select Your Academic Tier</h2>

            <!-- Dynamic Dashboard Stats (User Only) -->
            <div class="dashboard-stats state-user-only">
                <div class="stat-card glass-flat">
                    <span class="stat-label">Intellectual Strength</span>
                    <span class="stat-value">Elite</span>
                    <div class="stat-progress">
                        <div class="bar" style="width: 85%"></div>
                    </div>
                </div>
                <div class="stat-card glass-flat">
                    <span class="stat-label">Logic Clarity</span>
                    <span class="stat-value">Deep</span>
                    <div class="stat-progress">
                        <div class="bar" style="width: 92%"></div>
                    </div>
                </div>
                <div class="stat-card glass-flat">
                    <span class="stat-label">Memory Retention</span>
                    <span class="stat-value">+140%</span>
                    <div class="stat-progress">
                        <div class="bar" style="width: 78%"></div>
                    </div>
                </div>
            </div>

            <div class="card-grid">
                <div class="card">
                    <div class="card-header">
                        <h3>ENERGY STARTER</h3>
                        <div class="price">$19.90</div>
                    </div>
                    <ul class="features">
                        <li><span class="icon">‚ö°</span> 400 Zap Credits</li>
                        <li><span class="icon">‚úì</span> AI Socratic Tutoring</li>
                        <li><span class="icon">‚úì</span> 1M Context Window</li>
                        <li><span class="icon">‚úì</span> 7-Day History Access</li>
                    </ul>
                    <button class="btn secondary state-guest-only auth-trigger">Sign in to Buy</button>
                    <button class="btn secondary state-user-only buy-trigger" data-id="starter" data-price="19.90"
                        data-zaps="400" data-name="Energy Starter">Upgrade Now</button>
                </div>

                <div class="card pro">
                    <div class="popular-badge">BEST VALUE</div>
                    <div class="card-header">
                        <h3>ENERGY ADVANCE</h3>
                        <div class="price">$49</div>
                    </div>
                    <ul class="features">
                        <li><span class="icon">‚ö°</span> 1,200 Zap Credits</li>
                        <li><span class="icon">‚òÖ</span> AI Visual Reasoning</li>
                        <li><span class="icon">‚òÖ</span> Priority Gemini API</li>
                        <li><span class="icon">‚òÖ</span> 30-Day History</li>
                    </ul>
                    <button class="btn primary state-guest-only auth-trigger">Sign in to Buy</button>
                    <button class="btn primary state-user-only buy-trigger" data-id="advance" data-price="49.00"
                        data-zaps="1200" data-name="Energy Advance">Upgrade Now</button>
                </div>

                <div class="card premium">
                    <div class="card-header">
                        <h3>ENERGY SCHOLAR</h3>
                        <div class="price">$69</div>
                    </div>
                    <ul class="features">
                        <li><span class="icon">‚ö°</span> 1,800 Zap Credits</li>
                        <li><span class="icon">‚òÖ</span> Advanced Reasoning Models</li>
                        <li><span class="icon">‚òÖ</span> Unlimited Scan History</li>
                        <li><span class="icon">‚òÖ</span> 24/7 Priority Support</li>
                    </ul>
                    <button class="btn primary state-guest-only auth-trigger">Sign in to Buy</button>
                    <button class="btn primary state-user-only buy-trigger" data-id="scholar" data-price="69.00"
                        data-zaps="1800" data-name="Energy Scholar">Upgrade Now</button>
                </div>

                <div class="card ultimate">
                    <div class="card-header">
                        <h3>MEGA BUNDLE</h3>
                        <div class="price">$99</div>
                    </div>
                    <ul class="features">
                        <li><span class="icon">‚ö°</span> 3,000 Zap Credits</li>
                        <li><span class="icon">‚òÖ</span> Personal AI Mentor</li>
                        <li><span class="icon">‚òÖ</span> Everything in Scholar +</li>
                        <li><span class="icon">‚òÖ</span> Beta Feature Access</li>
                    </ul>
                    <button class="btn primary state-guest-only auth-trigger">Sign in to Buy</button>
                    <button class="btn primary state-user-only buy-trigger" data-id="mega" data-price="99.00"
                        data-zaps="3000" data-name="Mega Bundle">Upgrade Now</button>
                </div>
            </div>
        </section>

        <!-- Comparison Matrix: Why Pro? -->
        <section class="comparison glass-flat">
            <div class="section-label">THE QUANTUM LEAP</div>
            <h2 class="section-title">Baseline AI vs. <span>Socratic Pro</span></h2>
            <div class="table-wrapper">
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>Capability</th>
                            <th>Baseline (GPT/Free)</th>
                            <th>Socratic Pro</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Reasoning Depth</td>
                            <td>Surface Level (Pattern Match)</td>
                            <td class="highlight">1st Principle Decomposition</td>
                        </tr>
                        <tr>
                            <td>Visual Intelligence</td>
                            <td>Basic OCR</td>
                            <td class="highlight">Spatial Geometry Mastery</td>
                        </tr>
                        <tr>
                            <td>Feedback Loop</td>
                            <td>Binary (Right/Wrong)</td>
                            <td class="highlight">Socratic Guidance Matrix</td>
                        </tr>
                        <tr>
                            <td>Memory</td>
                            <td>32k - 128k Context</td>
                            <td class="highlight">1,000,000+ Deep Context</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Checkout Modal (Confirmation Step) -->
        <div id="checkout-modal" class="modal-overlay">
            <div class="modal-content glass-flat">
                <button class="modal-close" id="close-checkout">&times;</button>
                <div class="modal-header">
                    <h2>Verify Your Order</h2>
                    <p>Review your selection before proceeding to secure payment.</p>
                </div>
                <div class="order-summary">
                    <div class="summary-item">
                        <span class="label">Package</span>
                        <span id="summary-name" class="value">--</span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Resource</span>
                        <span id="summary-zaps" class="value">--</span>
                    </div>
                    <div class="summary-divider"></div>
                    <div class="summary-item total">
                        <span class="label">Total Amount</span>
                        <span id="summary-price" class="value">--</span>
                    </div>
                </div>
                <div class="payment-area">
                    <div id="paypal-button-container-checkout"></div>
                </div>
                <p class="modal-footer-note">Secure transaction processed via PayPal. Credits are applied instantly upon
                    success.</p>
            </div>
        </div>

        <!-- Energy Consumption Guide -->
        <section class="energy-rules">
            <div class="rules-container">
                <div class="rules-header">
                    <h2>‚ö° Energy Consumption Guide</h2>
                    <p>Transparent pricing for intelligent reasoning</p>
                </div>
                <div class="rules-grid">
                    <div class="rule-card">
                        <div class="rule-icon">üí¨</div>
                        <h4>L1: Discovery Tutor</h4>
                        <p>Standard text-based guided questioning.</p>
                        <div class="rule-cost">3 Zaps / Query</div>
                    </div>
                    <div class="rule-card">
                        <div class="rule-icon">üëÅÔ∏è</div>
                        <h4>L2: Visual Tutor</h4>
                        <p>AI analysis of screenshots and diagrams.</p>
                        <div class="rule-cost">8 Zaps / Query</div>
                    </div>
                    <div class="rule-card">
                        <div class="rule-icon">üß†</div>
                        <h4>L3: Thinking Mode</h4>
                        <p>Advanced chain-of-thought reasoning.</p>
                        <div class="rule-cost">Coming Soon</div>
                    </div>
                </div>
                <p class="rules-note">* Costs are calculated based on AI inference complexity to ensure the highest
                    quality tutoring.</p>
            </div>
        </section>

        <section class="billing-history state-user-only" id="billing-history">
            <div class="section-header">
                <h2>Transaction History</h2>
                <div class="history-tabs">
                    <button class="tab-btn active" data-tab="transactions">Transactions</button>
                    <button class="tab-btn" data-tab="usage">Energy Usage</button>
                </div>
            </div>

            <div class="history-container">
                <!-- Transactions Tab -->
                <div id="transactions" class="tab-content active">
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Plan</th>
                                <th>Amount</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="history-body">
                            <tr class="empty-state">
                                <td colspan="4">No transaction history found.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Energy Usage Tab -->
                <div id="usage" class="tab-content">
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Activity</th>
                                <th>Change</th>
                                <th>Balance</th>
                            </tr>
                        </thead>
                        <tbody id="usage-body">
                            <tr class="empty-state">
                                <td colspan="4">No energy usage recorded.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Legitimate Footer with Trust Markers -->
        <section class="trust-footer">
            <div class="trust-content">
                <div class="links">
                    <a href="legal.html?page=privacy">Privacy Policy</a>
                    <a href="legal.html?page=terms">Terms of Service</a>
                    <a href="legal.html?page=refund">Refund Policy</a>
                    <a href="legal.html?page=compliance">Compliance</a>
                    <a href="legal.html?page=contact">Contact Support</a>
                </div>
                <p class="copyright">&copy; 2026 Socratic AI. All rights reserved. ÁâàÊ¨äÊ≠∏Â±¨ Growth Education Limited</p>
                <div class="security-badge">
                    <span class="icon">üõ°Ô∏è</span> Google-grade encryption & SOC2 Compliance
                </div>
                <p class="disclaimer">Socratic AI is a research preview tool. Energy points have no monetary value.</p>
            </div>
        </section>
    </main>

    <!-- Firebase SDK Integration -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithRedirect, getRedirectResult, GoogleAuthProvider, signOut, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, updateDoc, arrayUnion, increment, serverTimestamp, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // Firebase Configuration (Matching Extension)
        const firebaseConfig = {
            apiKey: "AIzaSyDTn4TXLQCQHvtU_fwk-8lZd-6Nx5Udj7M",
            authDomain: "socratic-ai-82849.firebaseapp.com",
            projectId: "socratic-ai-82849",
            storageBucket: "socratic-ai-82849.firebasestorage.app",
            messagingSenderId: "528705306538",
            appId: "1:528705306538:web:2982f568ec05ee08a575d3"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        const energyCountLabel = document.getElementById('energy-count');
        const profileContainer = document.getElementById('user-profile');
        const loginBtn = document.getElementById('web-login-btn');
        const logoutBtn = document.getElementById('web-logout-btn');

        // Global Error Capture
        window.onerror = function (msg, url, line) {
            alert("System Error: " + msg + "\nAt: " + line);
            return false;
        };

        // 0. Unified Auth Logic
        async function runGoogleAuthFlow() {
            console.log("Auth Sequence: Iniciating Google Sign-In...");

            // Visual feedback
            const allAuthButtons = document.querySelectorAll('#web-login-btn, .auth-trigger');
            allAuthButtons.forEach(b => {
                b.style.opacity = '0.7';
                b.style.pointerEvents = 'none';
            });

            try {
                // We prefer popup for desktop as it's more intuitive
                console.log("Auth Sequence: Attempting signInWithPopup");
                const result = await signInWithPopup(auth, provider);
                console.log("Auth Sequence: Popup Success", result.user.email);
            } catch (error) {
                console.warn("Auth Sequence: Popup blocked or failed", error.code);

                // Nuclear fallback to Redirect for mobile/restricted environments
                if (error.code === 'auth/popup-blocked' || error.code === 'auth/cancelled-popup-request' || error.code === 'auth/popup-closed-by-user') {
                    console.log("Auth Sequence: Pivoting to signInWithRedirect");
                    await signInWithRedirect(auth, provider);
                } else if (error.code === 'auth/unauthorized-domain') {
                    alert("Critical: This domain is not authorized in Firebase Console. Please add your current domain to the authorized list.");
                } else {
                    console.error("Auth Sequence: Final Error", error);
                    alert("Authentication Error: " + error.message);
                }
            } finally {
                allAuthButtons.forEach(b => {
                    b.style.opacity = '1';
                    b.style.pointerEvents = 'auto';
                });
            }
        }

        // 1. Initial Sync from URL Params (Fast display)
        const urlParams = new URLSearchParams(window.location.search);
        const pictureUrl = urlParams.get('picture');
        const initial = urlParams.get('initial');
        const energyValue = urlParams.get('energy');

        if (energyValue) energyCountLabel.innerText = energyValue;
        if (pictureUrl) {
            profileContainer.innerHTML = `<img src="${pictureUrl}" alt="Avatar" style="width:100%;height:100%;object-fit:cover;display:block;border-radius:50%;">`;
        } else if (initial) {
            profileContainer.innerHTML = `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:var(--accent-primary);color:white;font-weight:700;border-radius:50%;">${initial}</div>`;
        }

        // 2. Real-time Firebase Sync (Consolidated)
        onAuthStateChanged(auth, (user) => {
            const body = document.body;
            const heroTitle = document.querySelector('.hero h1');
            const heroSubtitle = document.querySelector('.hero p');

            if (user) {
                console.log("Web Auth: Active User Session Detected", user.uid);
                body.classList.add('is-authenticated');

                // Update Hero for Personal Dashboard Mode
                heroTitle.innerText = `Welcome Back, ${user.displayName || 'Scholar'}`;
                heroSubtitle.innerText = "Manage your zap credits and view your intelligence growth.";

                // Update Avatar
                if (user.photoURL) {
                    profileContainer.innerHTML = `<img src="${user.photoURL}" alt="Avatar" style="width:100%;height:100%;object-fit:cover;display:block;border-radius:50%;">`;
                } else {
                    profileContainer.innerHTML = `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:var(--accent-primary);color:white;font-weight:700;border-radius:50%;">${(user.displayName || '?').charAt(0)}</div>`;
                }

                // 2a. User Document Initialization (Ensure profile exists)
                const userDocRef = doc(db, 'users', user.uid);

                // Real-time synchronization and initialization
                onSnapshot(userDocRef, async (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        energyCountLabel.innerText = data.energyBalance || 0;
                        renderHistory(data.transactions || []);
                    } else {
                        console.log("Web Auth: Creating new user profile in Firestore...");
                        energyCountLabel.innerText = '0';
                        try {
                            await setDoc(userDocRef, {
                                email: user.email,
                                displayName: user.displayName,
                                energyBalance: 0,
                                transactions: [],
                                createdAt: serverTimestamp()
                            }, { merge: true });
                        } catch (e) {
                            console.warn("Proactive initialization failed:", e);
                        }
                    }
                });

                // NO LONGER INITIALIZING PAYPAL BUTTONS ON LOAD
                // We do it only when the modal opens.

            } else {
                console.log("Web Auth: Guest Mode - Ready for Sign-In");
                body.classList.remove('is-authenticated');

                // Reset Hero for Promotional Mode
                heroTitle.innerText = "Elevate Your Intelligence";
                heroSubtitle.innerText = "Join thousands of students mastering complex concepts with Socratic Pro.";

                energyCountLabel.innerText = 'Login';
            }
        });

        // 3. Render Transaction History
        function renderHistory(transactions) {
            const historyBody = document.getElementById('history-body');
            const usageBody = document.getElementById('usage-body');

            if (transactions.length === 0) return;

            // Sort by date descending
            const sorted = [...transactions].sort((a, b) => (b.date?.seconds || 0) - (a.date?.seconds || 0));

            historyBody.innerHTML = sorted.map(t => `
                <tr>
                    <td>${t.date ? new Date(t.date.seconds * 1000).toLocaleDateString() : 'Pending'}</td>
                    <td>${t.packageName}</td>
                    <td>${t.amount}</td>
                    <td><span class="status-pill completed">COMPLETED</span></td>
                </tr>
            `).join('');

            usageBody.innerHTML = sorted.map(t => `
                <tr>
                    <td>${t.date ? new Date(t.date.seconds * 1000).toLocaleDateString() : 'Pending'}</td>
                    <td>Purchase: ${t.packageName}</td>
                    <td>+${t.zaps}‚ö°</td>
                    <td>--</td>
                </tr>
            `).join('');
        }

        // 4. Delegated Event Listeners (Bulletproof Pattern)
        document.addEventListener('click', (e) => {
            // Check if clicked element is an auth trigger or child of one
            const authTarget = e.target.closest('#web-login-btn') || e.target.closest('.auth-trigger');
            if (authTarget) {
                e.preventDefault();
                runGoogleAuthFlow();
                return;
            }

            // CHECKOUT FLOW TRIGGERS
            const buyTarget = e.target.closest('.buy-trigger');
            if (buyTarget) {
                const pkg = {
                    id: buyTarget.dataset.id,
                    price: buyTarget.dataset.price,
                    zaps: buyTarget.dataset.zaps,
                    name: buyTarget.dataset.name
                };
                openCheckoutModal(pkg);
            }
        });

        // 4a. Modal Management
        const checkoutModal = document.getElementById('checkout-modal');
        const closeCheckout = document.getElementById('close-checkout');

        function openCheckoutModal(pkg) {
            document.getElementById('summary-name').innerText = pkg.name;
            document.getElementById('summary-zaps').innerText = `+${pkg.zaps}‚ö°`;
            document.getElementById('summary-price').innerText = `$${pkg.price}`;

            checkoutModal.classList.add('active');

            // Clear existing and init fresh PayPal button for the selection
            document.getElementById('paypal-button-container-checkout').innerHTML = '';
            initPayPalButton('#paypal-button-container-checkout', pkg.price, parseInt(pkg.zaps), pkg.name);
        }

        closeCheckout.addEventListener('click', () => {
            checkoutModal.classList.remove('active');
            document.getElementById('paypal-button-container-checkout').innerHTML = '';
        });

        // Close on outside click
        window.onclick = (event) => {
            if (event.target == checkoutModal) {
                closeCheckout.click();
            }
        };

        // 5. Logout Action
        logoutBtn.addEventListener('click', () => {
            signOut(auth).then(() => {
                window.location.reload(); // Refresh to ensure clean state
            }).catch((error) => {
                console.error("Logout Error:", error);
            });
        });

        // 4. Handle Redirect Result (Catch errors on return)
        getRedirectResult(auth).catch((error) => {
            console.error("Login Result Error:", error);
            if (error.code === 'auth/unauthorized-domain') {
                alert("Domain not authorized in Firebase Console.");
            }
        });

        // 4. Tab Switching Logic
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');

        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const tabId = btn.getAttribute('data-tab');
                tabBtns.forEach(b => b.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(tabId).classList.add('active');
            });
        });

        // Handle Anchor Link
        if (window.location.hash === '#usage') {
            const usageBtn = document.querySelector('[data-tab="usage"]');
            if (usageBtn) usageBtn.click();
        }

        // --- PayPal Purchase Logic ---
        function initPayPalButton(containerId, amount, zaps, packageName) {
            paypal.Buttons({
                style: {
                    layout: 'vertical',
                    color: 'blue',
                    shape: 'rect',
                    label: 'paypal'
                },
                createOrder: function (data, actions) {
                    return actions.order.create({
                        purchase_units: [{
                            description: packageName,
                            amount: {
                                currency_code: "USD",
                                value: amount
                            }
                        }]
                    });
                },
                onApprove: function (data, actions) {
                    return actions.order.capture().then(async function (orderData) {
                        console.log('Capture result', orderData, JSON.stringify(orderData, null, 2));
                        const user = auth.currentUser;
                        if (user) {
                            const userDocRef = doc(db, 'users', user.uid);
                            // Update Energy Balance & Log Transaction
                            await updateDoc(userDocRef, {
                                energyBalance: increment(zaps),
                                transactions: arrayUnion({
                                    id: orderData.id,
                                    date: serverTimestamp(),
                                    amount: `$${amount}`,
                                    packageName: packageName,
                                    zaps: zaps,
                                    status: 'COMPLETED'
                                })
                            });
                            alert(`Purchase Successful! Added ${zaps} Zaps.`);
                        }
                    });
                },
                onError: function (err) {
                    console.error('PayPal Error:', err);
                    alert("Payment failed. Please try again.");
                }
            }).render(containerId);
        }

        // Remove redundant redundant auth listener to prevent state racing
        // 5. Scroll Reveal Logic
        const revealObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('active');
                }
            });
        }, { threshold: 0.1 });

        document.querySelectorAll('.reveal').forEach(el => revealObserver.observe(el));

        // 6. Dynamic Card Highlights
        document.querySelectorAll('.card').forEach(card => {
            card.addEventListener('mousemove', e => {
                const rect = card.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                card.style.setProperty('--x', `${x}px`);
                card.style.setProperty('--y', `${y}px`);
            });
        });
    </script>
</body>

</html>